Here is a comprehensive **Product Requirements Prompt (PRP)** designed for Replit (Claude 4.5 Sonnet) to implement the "Find My Budget" module.

This prompt is structured to ensure the AI understands the existing "Two-Brain" architecture (Node.js/Express BFF + Python Solver) and places the logic correctly. It includes the synthetic datasets required for agentic testing.

-----

# Product Requirements Prompt: "Find My Budget" Module Implementation

**Role:** Senior Full-Stack Architect & Financial Data Engineer
**Project:** Paydown Pilot (Existing Fintech App)
**Context:** We are expanding the app to automate the data entry process. Currently, users manually enter their budget. We are introducing **"Find My Budget,"** a feature that connects to the user's bank account (via TrueLayer), analyzes 6 months of transaction history, and deterministically calculates their "Safe-to-Spend" amount for debt repayment.

**Objective:** Implement the backend logic, data processing pipeline, and frontend visualization for the "Find My Budget" module. You will simulate the TrueLayer API using synthetic data for this phase.

-----

### 1\. Architectural Standards & Constraints

  * **The "Two-Brain" Rule:** This module belongs to the **Deterministic Logic** layer. Do not use LLMs to guess categories. Use strict keyword matching and TrueLayer's `transaction_classification` taxonomy.
  * **Tech Stack:**
      * **Backend:** Node.js/Express (TypeScript).
      * **Validation:** Zod (via `shared/schema.ts`).
      * **Data Processing:** `server/services/budget-engine.ts` (New file).
      * **Frontend:** React/Shadcn UI.

### 2\. Implementation Roadmap

#### Step 1: Data Structures (Zod & Types)

Update `shared/schema.ts` to include the structures for TrueLayer ingestion and Budget Analysis output.

  * **Input Schema (Mock TrueLayer):** Create interfaces for `TrueLayerTransaction`, `TrueLayerDirectDebit`, and `TrueLayerStandingOrder`.
  * **Output Schema:** Create a `BudgetAnalysisResponse` type that includes:
      * `averageMonthlyIncome`: integer (cents)
      * `fixedCosts`: integer (cents) (Rent, Bills, Direct Debits)
      * `variableEssentials`: integer (cents) (Groceries, Transport)
      * `discretionary`: integer (cents)
      * `safeToSpend`: integer (cents) (Income - Fixed - Variable)
      * `detectedDebtPayments`: Array of strings (Lender names found in transactions).

#### Step 2: The Budget Logic Engine (`server/services/budget-engine.ts`)

Create a deterministic service that processes a list of transactions. Implement the **"Safe-to-Spend" Algorithm**:

1.  **Income Calculation:** Sum positive transactions categorized as `Income` or `Salary`. Exclude internal transfers. Average over the dataset duration (e.g., 6 months).
2.  **Fixed Outgoings (High Priority):**
      * Sum all `Standing Orders` and `Direct Debits` (fetched from the specific mock endpoints).
      * Sum transactions classified as `["Bills", "Rent"]`, `["Bills", "Utilities"]`, `["Home", "Mortgage"]`.
3.  **Variable Essentials:**
      * Sum transactions classified as `["Shopping", "Groceries"]`, `["Transport", ...]`, `["Health", ...]`.
      * Calculate the monthly average.
4.  **Discretionary:** Everything else (Dining, Entertainment, Shopping).
5.  **Debt Detection:** Scan transaction descriptions for keywords (`AMEX`, `BARCLAYCARD`, `LOAN`, `KLARNA`). Return these names to suggest accounts to the user later.

#### Step 3: API Endpoint

Create `server/routes/budget-analysis.ts`:

  * `POST /api/budget/analyze`: Accepts a `personaId` (for testing) or raw transaction data. Returns the `BudgetAnalysisResponse`.

#### Step 4: Frontend "Budget Finder" Flow

  * Create a generic "Connect Bank" button (simulated).
  * **Loading State:** Show a "Analyzing 6 months of data..." animation.
  * **Results View:** Display the calculated budget breakdown.
      * *Visual:* A bar chart showing Income vs. Outgoings.
      * *Action:* "Apply to Budget" button that updates the user's `currentBudgetCents` in the DB.

-----

### 3\. Agentic Testing Plan (Synthetic Data)

To verify the logic without live API keys, you must create a file `server/mock-data/truelayer-personas.ts`. Use the **5 Personas** defined below to stress-test the logic.

**Test Procedure:**

1.  Create a unit test that runs all 5 personas through the `BudgetEngine`.
2.  Assert that "The Student" has low income and high discretionary spend.
3.  Assert that "The Family" has high fixed costs (Mortgage) and specific Direct Debits.
4.  Assert that "Debt Detected" array correctly finds "Amex" for the High Earner.

-----

### 4\. Synthetic Data Sets (The 5 Personas)

Copy these JSON structures into `server/mock-data/truelayer-personas.ts` and export them.

#### Persona 1: The "High Earner, High Spender" (London)

*Scenario: High salary, high rent, active credit card user.*

```typescript
export const PERSONA_HIGH_EARNER = {
  id: "user_001",
  transactions: [
    { description: "TECH CORP PAYROLL", amount: 4500.00, transaction_classification: ["Income", "Salary"], transaction_type: "CREDIT" },
    { description: "LONDON ESTATES RENT", amount: -2200.00, transaction_classification: ["Bills", "Rent"], transaction_type: "STANDING_ORDER" },
    { description: "WAITROSE KENSINGTON", amount: -125.50, transaction_classification: ["Shopping", "Groceries"], transaction_type: "DEBIT" },
    { description: "AMEX DIRECT DEBIT", amount: -500.00, transaction_classification: ["Bills", "Credit Card"], transaction_type: "DIRECT_DEBIT" },
    { description: "SOHO HOUSE", amount: -250.00, transaction_classification: ["Entertainment", "Dining Out"], transaction_type: "DEBIT" }
  ],
  direct_debits: [
    { name: "AMEX", amount: 0 }, // Amount variable, but existence implies commitment
    { name: "THAMES WATER", amount: 35.00 }
  ]
};
```

#### Persona 2: The "Squeezed Middle" (Family)

*Scenario: Mortgage, Council Tax, weekly big shops, tight budget.*

```typescript
export const PERSONA_FAMILY = {
  id: "user_002",
  transactions: [
    { description: "NHS TRUST SALARY", amount: 2800.00, transaction_classification: ["Income", "Salary"], transaction_type: "CREDIT" },
    { description: "HALIFAX MORTGAGE", amount: -1100.00, transaction_classification: ["Home", "Mortgage"], transaction_type: "DIRECT_DEBIT" },
    { description: "COUNCIL TAX", amount: -150.00, transaction_classification: ["Bills", "Tax"], transaction_type: "DIRECT_DEBIT" },
    { description: "TESCO SUPERSTORE", amount: -180.00, transaction_classification: ["Shopping", "Groceries"], transaction_type: "DEBIT" },
    { description: "E.ON ENERGY", amount: -120.00, transaction_classification: ["Bills", "Utilities"], transaction_type: "DIRECT_DEBIT" },
    { description: "NETFLIX", amount: -15.99, transaction_classification: ["Entertainment", "Subscription"], transaction_type: "DEBIT" }
  ],
  direct_debits: [{ name: "HALIFAX", amount: 1100.00 }, { name: "E.ON", amount: 120.00 }]
};
```

#### Persona 3: The "Student / Gig Worker"

*Scenario: Irregular income, low fixed costs, high variable spend.*

```typescript
export const PERSONA_GIG_WORKER = {
  id: "user_003",
  transactions: [
    { description: "UBER EATS PAYOUT", amount: 150.00, transaction_classification: ["Income"], transaction_type: "CREDIT" },
    { description: "UBER EATS PAYOUT", amount: 320.00, transaction_classification: ["Income"], transaction_type: "CREDIT" },
    { description: "PRET A MANGER", amount: -8.50, transaction_classification: ["Entertainment", "Dining Out"], transaction_type: "DEBIT" },
    { description: "TFL TRAVEL", amount: -6.40, transaction_classification: ["Transport", "Public Transport"], transaction_type: "DEBIT" },
    { description: "STUDENT LOANS CO", amount: -40.00, transaction_classification: ["Education", "Loan"], transaction_type: "DIRECT_DEBIT" },
    { description: "SPOTIFY", amount: -9.99, transaction_classification: ["Entertainment", "Subscription"], transaction_type: "DEBIT" }
  ],
  direct_debits: [{ name: "STUDENT LOANS CO", amount: 40.00 }]
};
```

#### Persona 4: The "Debt Spiral"

*Scenario: High debt repayments, gambling, overdraft fees.*

```typescript
export const PERSONA_DEBT_HEAVY = {
  id: "user_004",
  transactions: [
    { description: "CONSTRUCTION LTD PAY", amount: 2200.00, transaction_classification: ["Income", "Salary"], transaction_type: "CREDIT" },
    { description: "WILLIAM HILL", amount: -50.00, transaction_classification: ["Entertainment", "Betting"], transaction_type: "DEBIT" },
    { description: "BARCLAYCARD", amount: -200.00, transaction_classification: ["Bills", "Credit Card"], transaction_type: "DEBIT" },
    { description: "CAPITAL ONE", amount: -150.00, transaction_classification: ["Bills", "Credit Card"], transaction_type: "DEBIT" },
    { description: "LLOYDS OVERDRAFT FEE", amount: -25.00, transaction_classification: ["Bank Charges"], transaction_type: "FEE" },
    { description: "KWIK FIT", amount: -400.00, transaction_classification: ["Transport", "Car Maintenance"], transaction_type: "DEBIT" }
  ],
  direct_debits: []
};
```

#### Persona 5: The "Clean Slate" (Edge Case)

*Scenario: New account, minimal data.*

```typescript
export const PERSONA_NEW_USER = {
  id: "user_005",
  transactions: [
    { description: "OPENING DEPOSIT", amount: 1000.00, transaction_classification: ["Income", "Transfer"], transaction_type: "CREDIT" }
  ],
  direct_debits: []
};
```

-----

**Instruction to Replit Agent:**
Start by creating the mock data file. Then, build the `BudgetEngine` service and run a script to validate that it correctly calculates the `safeToSpend` figure for the "Family" persona (Income - Mortgage - Tax - Energy - Groceries) before you build the Frontend UI. Correctness of the math is the priority.